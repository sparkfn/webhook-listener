<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Webhook Listener</title>
    <style>
      :root {
        --bg: #0f1115;
        --panel: #151924;
        --panel-2: #1b2130;
        --text: #e6e9ef;
        --muted: #9aa3b2;
        --accent: #6de1ff;
        --accent-2: #8bffb0;
        --border: #2a3245;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Space Grotesk", system-ui, sans-serif;
        background: radial-gradient(1200px 600px at 80% -20%, #1f2a44 0%, rgba(15,17,21,0) 60%), var(--bg);
        color: var(--text);
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        background: rgba(10, 12, 16, 0.8);
        position: sticky;
        top: 0;
        z-index: 5;
        backdrop-filter: blur(6px);
      }
      .title { font-weight: 600; letter-spacing: 0.5px; }
      .title-wrap {
        display: flex;
        align-items: baseline;
        gap: 12px;
        flex-wrap: wrap;
      }
      .hook-url {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
        font-size: 12px;
        color: var(--accent);
        background: #0b0f17;
        border: 1px solid var(--border);
        padding: 4px 8px;
        border-radius: 8px;
      }
      .controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      select {
        background: var(--panel);
        color: var(--text);
        border: 1px solid var(--border);
        padding: 6px 10px;
        border-radius: 8px;
      }
      main {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 16px;
        padding: 16px;
        max-width: 1400px;
        margin: 0 auto;
      }
      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
      }
      .panel header {
        position: static;
        background: var(--panel-2);
        border-bottom: 1px solid var(--border);
      }
      .events {
        max-height: calc(100vh - 140px);
        overflow: auto;
      }
      .event {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
      }
      .event.active {
        background: #222a3d;
        border-left: 3px solid var(--accent);
      }
      .event small { color: var(--muted); }
      .detail {
        padding: 16px;
        display: grid;
        gap: 16px;
      }
      .detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      .table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 16px;
      }
      .table th,
      .table td {
        text-align: left;
        padding: 8px 10px;
        border-bottom: 1px solid var(--border);
        vertical-align: top;
      }
      .table th {
        color: var(--muted);
        font-weight: 500;
        width: 180px;
      }
      pre {
        background: #0c0f17;
        border: 1px solid var(--border);
        padding: 12px;
        border-radius: 8px;
        overflow: auto;
        max-height: 360px;
      }
      .pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        background: #1b2a3d;
        color: var(--accent);
        border: 1px solid #2f4764;
        margin-left: 6px;
      }
      .toggle {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        margin-right: 12px;
        color: var(--muted);
        font-size: 12px;
      }
      .payload-tools {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 8px 0;
      }
      .muted {
        color: var(--muted);
      }
      @media (max-width: 900px) {
        main { grid-template-columns: 1fr; }
        .events { max-height: 300px; }
      }
      @media (max-width: 1100px) {
        .detail-grid { grid-template-columns: 1fr; }
      }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet" />
  </head>
  <body>
    <header>
      <div class="title-wrap">
        <div class="title">Webhook Listener</div>
        <div id="hookUrl" class="hook-url">/hook/</div>
      </div>
      <div class="controls">
        <label for="ns">Namespace</label>
        <select id="ns"></select>
        <span id="status" class="pill">offline</span>
      </div>
    </header>
    <main>
      <section class="panel">
        <header>
          <div class="title">Events</div>
        </header>
        <div id="events" class="events"></div>
      </section>
      <section class="panel">
        <header>
          <div class="title">Details</div>
        </header>
        <div class="detail">
          <div class="detail-grid">
            <section>
              <h3>Request Details</h3>
              <table class="table" id="meta"></table>
            </section>
            <section>
              <h3>Headers</h3>
              <table class="table" id="headers"></table>
            </section>
          </div>
          <div class="detail-grid">
            <section>
              <h3>Query Strings</h3>
              <table class="table" id="query"></table>
            </section>
            <section>
              <h3>Form Values</h3>
              <table class="table" id="form"></table>
            </section>
          </div>
          <section>
            <h3>Request Content</h3>
            <div class="payload-tools">
              <div>
                <label class="toggle"><input type="checkbox" id="formatJson" checked /> Format JSON</label>
                <label class="toggle"><input type="checkbox" id="wrap" checked /> Word Wrap</label>
              </div>
              <div class="muted" id="payloadMeta"></div>
            </div>
            <pre id="payload"></pre>
          </section>
        </div>
      </section>
    </main>
    <script>
      const nsSelect = document.getElementById("ns");
      const eventsEl = document.getElementById("events");
      const metaEl = document.getElementById("meta");
      const queryEl = document.getElementById("query");
      const formEl = document.getElementById("form");
      const headersEl = document.getElementById("headers");
      const payloadEl = document.getElementById("payload");
      const payloadMetaEl = document.getElementById("payloadMeta");
      const formatJsonEl = document.getElementById("formatJson");
      const wrapEl = document.getElementById("wrap");
      const statusEl = document.getElementById("status");
      const hookUrlEl = document.getElementById("hookUrl");

      let events = [];
      let currentNs = "";
      let activeId = "";

      function setStatus(text, ok) {
        statusEl.textContent = text;
        statusEl.style.color = ok ? "var(--accent-2)" : "var(--accent)";
      }

      function renderEvents() {
        eventsEl.innerHTML = "";
        events.slice().reverse().forEach((evt) => {
          const div = document.createElement("div");
          div.className = "event";
          if (evt.id === activeId) {
            div.classList.add("active");
          }
          div.innerHTML = `<div><strong>${evt.method}</strong> <small>${evt.timestamp}</small></div>` +
            `<div><small>${evt.path}</small></div>`;
          div.onclick = () => {
            activeId = evt.id;
            showEvent(evt);
            renderEvents();
          };
          eventsEl.appendChild(div);
        });
      }

      function showEvent(evt) {
        const sizeBytes = Number(evt.sizeBytes ?? (evt.bodyRaw ? evt.bodyRaw.length : 0));
        const durationMs = Number(evt.durationMs ?? 0);
        metaEl.innerHTML = `
          <tr><th>Method</th><td>${evt.method || ""}</td></tr>
          <tr><th>URL</th><td>${evt.fullUrl || evt.path || ""}</td></tr>
          <tr><th>Host</th><td>${evt.host || ""}</td></tr>
          <tr><th>Date</th><td>${evt.timestamp || ""}</td></tr>
          <tr><th>Size</th><td>${sizeBytes} bytes</td></tr>
          <tr><th>Time</th><td>${durationMs.toFixed(3)} ms</td></tr>
          <tr><th>ID</th><td>${evt.id || ""}</td></tr>
          <tr><th>Remote</th><td>${evt.remoteAddress || ""}</td></tr>
          <tr><th>User-Agent</th><td>${evt.userAgent || ""}</td></tr>
        `;

        const qs = evt.queryStrings || [];
        queryEl.innerHTML = qs.length
          ? qs.map((q) => `<tr><th>${q.name}</th><td>${q.value}</td></tr>`).join("")
          : `<tr><th colspan="2">None</th></tr>`;

        const formValues = evt.formValues || [];
        const formFiles = evt.formFiles || [];
        const formRows = [
          ...formValues.map((f) => `<tr><th>${f.name}</th><td>${f.value}</td></tr>`),
          ...formFiles.map(
            (f) => `<tr><th>${f.name}</th><td>${f.filename} (${f.mimeType})</td></tr>`
          )
        ];
        formEl.innerHTML = formRows.length
          ? formRows.join("")
          : `<tr><th colspan="2">None</th></tr>`;

        headersEl.innerHTML = Object.entries(evt.headers || {})
          .map(([k, v]) => `<tr><th>${k}</th><td>${Array.isArray(v) ? v.join(", ") : v}</td></tr>`)
          .join("");

        const size = sizeBytes || 0;
        payloadMetaEl.textContent = evt.contentLength
          ? `content-length: ${evt.contentLength} | ${size} bytes`
          : `${size} bytes`;

        const useWrap = wrapEl.checked;
        payloadEl.style.whiteSpace = useWrap ? "pre-wrap" : "pre";

        if (evt.bodyJson !== undefined && evt.bodyJson !== null && formatJsonEl.checked) {
          payloadEl.textContent = JSON.stringify(evt.bodyJson, null, 2);
        } else {
          payloadEl.textContent = evt.bodyRaw || "(empty)";
        }
      }

      async function loadNamespaces() {
        const res = await fetch("/api/namespaces");
        const data = await res.json();
        nsSelect.innerHTML = "";
        data.namespaces.forEach((ns) => {
          const opt = document.createElement("option");
          opt.value = ns;
          opt.textContent = ns;
          nsSelect.appendChild(opt);
        });
        currentNs = data.namespaces[0] || "";
        nsSelect.value = currentNs;
        updateHookUrl();
      }

      async function loadEvents() {
        if (!currentNs) return;
        const res = await fetch(`/api/events?ns=${encodeURIComponent(currentNs)}`);
        const data = await res.json();
        events = data.events || [];
        renderEvents();
        if (events.length) {
          activeId = events[events.length - 1].id;
          showEvent(events[events.length - 1]);
          renderEvents();
        }
      }

      nsSelect.addEventListener("change", async () => {
        currentNs = nsSelect.value;
        updateHookUrl();
        await loadEvents();
      });

      function connectWs() {
        const proto = location.protocol === "https:" ? "wss" : "ws";
        const ws = new WebSocket(`${proto}://${location.host}/ws`);
        ws.onopen = () => setStatus("live", true);
        ws.onclose = () => setStatus("offline", false);
        ws.onmessage = (msg) => {
          try {
            const data = JSON.parse(msg.data);
          if (data.type === "event" && data.event.namespace === currentNs) {
            events.push(data.event);
            activeId = data.event.id;
            renderEvents();
            showEvent(data.event);
          }
          } catch {}
        };
      }

      function refreshActive() {
        if (events.length) {
          showEvent(events[events.length - 1]);
        }
      }

      function updateHookUrl() {
        if (!currentNs) {
          hookUrlEl.textContent = "/hook/";
          return;
        }
        hookUrlEl.textContent = `${location.protocol}//${location.host}/hook/${currentNs}`;
      }

      formatJsonEl.addEventListener("change", refreshActive);
      wrapEl.addEventListener("change", refreshActive);

      (async () => {
        await loadNamespaces();
        await loadEvents();
        connectWs();
      })();
    </script>
  </body>
</html>
